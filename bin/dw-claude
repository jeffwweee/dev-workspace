#!/bin/bash
# dw-claude - Start Claude with dev-workspace context injected
# Usage: dw-claude [any claude args...]

WORKSPACE_ROOT="/home/jeffrey/jef-workspace/dev-workspace"

# Find claude binary (check common locations)
find_claude() {
    # Try PATH first
    if command -v claude &>/dev/null; then
        echo "claude"
        return
    fi
    # Try common locations
    for path in \
        "$HOME/.local/share/claude/versions/"* \
        "/opt/homebrew/bin/claude" \
        "/usr/local/bin/claude"
    do
        if [ -x "$path" ]; then
            echo "$path"
            return
        fi
    done
    # Fallback: find latest version
    local latest=$(ls -1v "$HOME/.local/share/claude/versions/" 2>/dev/null | tail -1)
    if [ -n "$latest" ]; then
        echo "$HOME/.local/share/claude/versions/$latest"
        return
    fi
    echo "claude"  # fallback to PATH
}

# Get time-based greeting
get_greeting() {
    hour=$(date +%H)
    if [ "$hour" -lt 12 ]; then
        echo "Good morning"
    elif [ "$hour" -lt 17 ]; then
        echo "Good afternoon"
    else
        echo "Good evening"
    fi
}

CLAUDE_BIN=$(find_claude)

# Check if we're in the workspace or a subdirectory
if [[ "$PWD" == "$WORKSPACE_ROOT"* ]]; then
    GREETING=$(get_greeting)

    # Initialize session (shows picker if sessions exist, creates new if not)
    cd "$WORKSPACE_ROOT"
    INIT_OUTPUT=$(node bin/dw.js init 2>&1)

    # Parse init output to get session info
    SESSION_ID=$(echo "$INIT_OUTPUT" | grep -o '"id": *"[^"]*"' | head -1 | cut -d'"' -f4)

    # Simple prompt - greeting, session info, and instruction
    cat << EOF | "$CLAUDE_BIN" "$@"
$GREETING. Session initialized.

$INIT_OUTPUT

Run /skill project-session --select to choose a project and task.
EOF
else
    # Not in workspace, just start claude normally
    "$CLAUDE_BIN" "$@"
fi
